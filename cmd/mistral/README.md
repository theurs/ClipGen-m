# Mistral CLI

Mistral CLI - это мощный консольный интерфейс для взаимодействия с API Mistral, с поддержкой расширенных инструментов, интеграции с Lua для выполнения сложных вычислений и веб-поиска через Tavily.

## Особенности

- **Инструменты**: Встроенная поддержка вызова инструментов для выполнения различных задач
  - **Калькулятор**: Использование Lua для выполнения математических вычислений, алгоритмов и скриптов
  - **Поиск**: Интеграция с Tavily API для выполнения веб-поиска с актуальной информацией
- **Режимы работы**: general, code, vision, audio, ocr
- **Чат**: Поддержка диалогов с сохранением истории
- **Файлы**: Поддержка работы с изображениями, аудио и текстовыми файлами
- **Поддержка аудио**: Для лучшей совместимости с различными форматами аудио рекомендуется использовать установленный в системе ffmpeg для предварительной конвертации файлов в поддерживаемые форматы (MP3, WAV)
- **Переключение моделей**: Автоматическое переключение между моделями при ошибках
- **Управление ключами**: Поддержка нескольких API-ключей с автоматическим переключением
- **Ротация ключей Tavily**: Случайное перемешивание ключей для равномерного распределения нагрузки

## Установка

1. Скачайте исполняемый файл `mistral.exe`
2. Убедитесь, что в системе установлены необходимые зависимости:
   - Go (для запуска Lua-скриптов, если используется локально)
3. (Опционально) Установите API-ключи для использования (см. раздел "Ключи")

## Использование

### Базовое использование

```bash
# Простой запрос (инструменты включены по умолчанию)
echo "Привет! Как дела?" | mistral

# Запрос с файлом
mistral -f файл.txt

# Запрос с изображением
mistral -f фото.jpg

# Запрос с несколькими файлами
mistral -f файл1.txt -f изображение.jpg
```

### Режимы работы

```bash
# Режим по умолчанию (general)
echo "Объясни смысл жизни" | mistral

# Режим кода
echo "Объясни этот код" | mistral -m code

# Режим зрения (для изображений)
mistral -f image.jpg -m vision

# Режим аудио (для аудио файлов)
mistral -f audio.mp3 -m audio

# Режим OCR (для PDF/изображений с текстом)
mistral -f document.pdf -m ocr
```

### Параметры командной строки

- `-f файл`: Добавить файл к запросу (можно использовать несколько раз)
- `-s "системный промпт"`: Задать свой системный промпт (заменяет конфигурационный)
- `-j`: Форсировать JSON вывод
- `-m режим`: Режим работы (auto, general, code, ocr, audio, vision)  
- `-t температура`: Температура генерации (0.0-2.0, заменяет конфигурационную)
- `-v`: Включить verbose логирование в stderr
- `-save-key ВАШ_КЛЮЧ`: Сохранить Mistral API ключ и выйти
- `-add-tavily-key ВАШ_КЛЮЧ`: Сохранить Tavily API ключ и выйти
- `-chat ID`: ID чата для контекста (включает режим чата)
- `-clear-chat ID`: Очистить историю указанного чата
- `-no-tools`: Отключить режим вызова инструментов (инструменты включены по умолчанию)

### Примеры использования инструментов

Mistral автоматически решает, когда использовать инструменты, основываясь на запросе пользователя:

```bash
# Калькулятор: Математические вычисления
echo "Чему равно 25 * 36 + 17 * 42?" | mistral

# Калькулятор: Алгоритмы Lua
echo "Вычисли факториал 15" | mistral

# Калькулятор: Программы на Lua
echo "Напиши Lua-скрипт, который сортирует массив [5, 2, 8, 1, 9]" | mistral

# Поиск: Веб-поиск через Tavily
echo "Какие последние новости о языке программирования Go?" | mistral

# Поиск: Рыночные данные
echo "Какова цена акций Apple сегодня?" | mistral

# Смешанные запросы
echo "Найди курс доллара и вычисли, сколько будет 100 долларов в рублях" | mistral
```

### Режим чата

```bash
# Начать новый чат
echo "Привет, как дела?" | mistral -chat мой_чат

# Продолжить чат (история сохраняется)
echo "А что ты умеешь?" | mistral -chat мой_чат

# Задать вопрос с контекстом из истории
echo "Напомни, о чем мы говорили?" | mistral -chat мой_чат

# Очистить историю чата
mistral -clear-chat мой_чат

# Очистить чат командой в сообщении
echo "/clear" | mistral -chat мой_чат
```

### JSON формат

```bash
# Форсировать JSON вывод
echo "Создай JSON с информацией о пользователе" | mistral -j
```

## Конфигурация

### Пути к файлам

- **Конфигурационный файл**: `%APPDATA%\clipgen-m\mistral.conf`
- **Конфигурация Tavily**: `%APPDATA%\clipgen-m\tavily.conf`  
- **История чатов**: `%APPDATA%\clipgen-m\mistral_chats\`
- **Логи ошибок**: `%APPDATA%\clipgen-m\mistral_err.log`

### Формат конфигурационного файла

Файл `mistral.conf` в формате JSON:

```json
{
  "api_keys": [
    "ваш_первый_mistral_api_ключ",
    "ваш_второй_mistral_api_ключ"
  ],
  "base_url": "https://api.mistral.ai",
  "system_prompt": "Ваш системный промпт по умолчанию",
  "temperature": 0.7,
  "max_tokens": 8000,
  "models": {
    "general": ["mistral-small-latest", "mistral-medium-latest"],
    "code": ["codestral-latest", "mistral-large-latest"],
    "vision": ["pixtral-12b-2409", "mistral-large-latest"],
    "audio": ["voxtral-mini-latest"],
    "ocr": ["mistral-ocr-latest"]
  },
  "chat_history_max_messages": 30,
  "chat_history_max_chars": 50000,
  "image_char_cost": 2000
}
```

### Формат конфигурации Tavily

Файл `tavily.conf` в формате JSON:

```json
{
  "api_keys": [
    "ваш_первый_tavily_api_ключ",
    "ваш_второй_tavily_api_ключ",
    "ваш_третий_tavily_api_ключ"
  ]
}
```

## Управление ключами

### Добавление ключей

```bash
# Добавить Mistral API ключ
mistral -save-key sk-abcdefghijklmnopqrstuvwxyz1234567890

# Добавить Tavily API ключ
mistral -add-tavily-key tvly-abcdefghijklmnopqrstuvwxyz1234567890
```

### Множественные ключи

Mistral поддерживает использование нескольких ключей:
- Для Mistral API: автоматическое переключение при ошибках авторизации или лимитах
- Для Tavily API: случайное перемешивание ключей для равномерного распределения нагрузки

## Логирование

- **Вербозный режим**: Используйте флаг `-v` для подробного логирования в stderr
- **Файл логов ошибок**: `%APPDATA%\clipgen-m\mistral_err.log`
- **Ротация логов**: Файл логов ротируется при достижении 10MB

## Система вызова инструментов

Mistral использует встроенную систему вызова инструментов:

### Калькулятор (Lua)

- Выполняет математические вычисления с высокой точностью
- Поддерживает все функции Lua и стандартные библиотеки
- Может выполнять сложные алгоритмы и скрипты
- Безопасное выполнение в изолированной среде

### Поиск (Tavily)

- Выполняет веб-поиск с актуальной информацией
- Возвращает краткие выжимки и топ результатов
- Поддерживает несколько API-ключей с ротацией
- Ограничивает размер контента для предотвращения перегрузки контекста

## Совместимость

- **ОС**: Windows, Linux, macOS (требуется адаптация путей)
- **Требования**: Современная версия Go (для работы Lua-исполнителя)
- **Зависимости**: golang.org/x/text/encoding/charmap, другие стандартные библиотеки Go

## Устранение неполадок

1. **"Нет входных данных"**: Убедитесь, что вы передаете что-то в stdin или используете файлы
2. **"Нет API ключей"**: Добавьте хотя бы один ключ с помощью `mistral -save-key ВАШ_КЛЮЧ`
3. **Ошибки с инструментами**: Проверьте, установлены ли соответствующие конфигурации
4. **Проблемы с Lua**: Убедитесь, что исполняемый файл `lua-executor` доступен
5. **Проблемы с Tavily**: Убедитесь, что файл `tavily.conf` правильно настроен

## Разработка

Проект написан на Go и может быть скомпилирован с помощью:

```bash
go build -o mistral.exe main.go
```

### Архитектура

- **main.go**: Основная логика приложения
- **lua-executor/**: Подсистема выполнения Lua-скриптов
- **tavily-test/**: Подсистема поиска через Tavily

## Лицензия

Этот проект распространяется по лицензии MIT.

## Авторы

ClipGen-m проект