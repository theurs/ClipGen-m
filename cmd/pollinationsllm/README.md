# Pollinations CLI

Pollinations CLI - это мощный консольный интерфейс для взаимодействия с API Pollinations, с поддержкой расширенных инструментов, интеграции с Lua для выполнения сложных вычислений и веб-поиска через Tavily.

## Особенности

- **Инструменты**: Встроенная поддержка вызова инструментов для выполнения различных задач
  - **Калькулятор**: Использование Lua для выполнения математических вычислений, алгоритмов и скриптов
  - **Поиск**: Интеграция с Tavily API для выполнения веб-поиска с актуальной информацией
  - **Поиск через Pollinations**: Использование модели gemini-search на Pollinations для поиска информации
- **Режимы работы**: general, code, vision, audio, ocr
- **Чат**: Поддержка диалогов с сохранением истории
- **Файлы**: Поддержка работы с изображениями, аудио и текстовыми файлами
- **Поддержка аудио**: Для лучшей совместимости с различными форматами аудио рекомендуется использовать установленный в системе ffmpeg для предварительной конвертации файлов в поддерживаемые форматы (MP3, WAV)
- **Управление ключами**: Поддержка API-ключа Pollinations (необязательно, так как Pollinations может работать без ключа)
- **Ротация ключей Tavily**: Случайное перемешивание ключей для равномерного распределения нагрузки

## Установка

1. Скачайте исполняемый файл `plnllm.exe`
2. Убедитесь, что в системе установлены необходимые зависимости:
   - Go (для запуска Lua-скриптов, если используется локально)
   - (Опционально) ffmpeg для поддержки редких аудио форматов
3. (Опционально) Установите API-ключи для использования (см. раздел "Ключи")

## Использование

### Базовое использование

```bash
# Простой запрос (инструменты включены по умолчанию)
echo "Привет! Как дела?" | plnllm

# Запрос с файлом
plnllm -f файл.txt

# Запрос с изображением
plnllm -f фото.jpg

# Запрос с несколькими файлами
plnllm -f файл1.txt -f изображение.jpg
```

### Режимы работы

```bash
# Режим по умолчанию (general)
echo "Объясни смысл жизни" | plnllm

# Режим кода
echo "Объясни этот код" | plnllm -m code

# Режим зрения (для изображений)
plnllm -f image.jpg -m vision

# Режим аудио (для аудио файлов)
plnllm -f audio.mp3 -m audio

# Режим OCR (для PDF/изображений с текстом)
plnllm -f document.pdf -m ocr
```

### Параметры командной строки

- `-f файл`: Добавить файл к запросу (можно использовать несколько раз)
- `-s "системный промпт"`: Задать свой системный промпт (заменяет конфигурационный)
- `-j`: Форсировать JSON вывод
- `-m режим`: Режим работы (auto, general, code, ocr, audio, vision)
- `-t температура`: Температура генерации (0.0-2.0, заменяет конфигурационную)
- `-v`: Включить verbose логирование в stderr
- `-save-key ВАШ_КЛЮЧ`: Сохранить Pollinations API ключ и выйти
- `-add-tavily-key ВАШ_КЛЮЧ`: Сохранить Tavily API ключ и выйти
- `-chat ID`: ID чата для контекста (включает режим чата)
- `-clear-chat ID`: Очистить историю указанного чата
- `-no-tools`: Отключить режим вызова инструментов (инструменты включены по умолчанию)

### Примеры использования инструментов

Pollinations автоматически решает, когда использовать инструменты, основываясь на запросе пользователя:

```bash
# Калькулятор: Математические вычисления
echo "Чему равно 25 * 36 + 17 * 42?" | plnllm

# Калькулятор: Алгоритмы Lua
echo "Вычисли факториал 15" | plnllm

# Калькулятор: Программы на Lua
echo "Напиши Lua-скрипт, который сортирует массив [5, 2, 8, 1, 9]" | plnllm

# Поиск: Веб-поиск через Tavily
echo "Какие последние новости о языке программирования Go?" | plnllm

# Поиск: Рыночные данные
echo "Какова цена акций Apple сегодня?" | plnllm

# Поиск: Через модель gemini-search на Pollinations
echo "Найди актуальную информацию о состоянии API Pollinations" | plnllm

# Смешанные запросы
echo "Найди курс доллара и вычисли, сколько будет 100 долларов в рублях" | plnllm
```

### Режим чата

```bash
# Начать новый чат
echo "Привет, как дела?" | plnllm -chat мой_чат

# Продолжить чат (история сохраняется)
echo "А что ты умеешь?" | plnllm -chat мой_чат

# Задать вопрос с контекстом из истории
echo "Напомни, о чем мы говорили?" | plnllm -chat мой_чат

# Очистить историю чата
plnllm -clear-chat мой_чат

# Очистить чат командой в сообщении
echo "/clear" | plnllm -chat мой_чат
```

### JSON формат

```bash
# Форсировать JSON вывод
echo "Создай JSON с информацией о пользователе" | plnllm -j
```

## Конфигурация

### Пути к файлам

- **Конфигурационный файл**: `%APPDATA%\clipgen-m\pollinations.conf`
- **Конфигурация Tavily**: `%APPDATA%\clipgen-m\tavily.conf`
- **История чатов**: `%APPDATA%\clipgen-m\mistral_chats\`
- **Логи ошибок**: `%APPDATA%\clipgen-m\pollinations_err.log`

### Формат конфигурационного файла

Файл `pollinations.conf` в формате JSON:

```json
{
  "api_keys": [
    "ваш_pollinations_api_ключ"
  ],
  "base_url": "https://gen.pollinations.ai/v1",
  "system_prompt": "Вы — ИИ-ассистент, интегрированный в инструмент ClipGen-m. Ваш вывод часто копируется в буфер обмена. Будьте лаконичны. Если это лог ошибки — объясните причину. Не используйте вводные фразы типа 'Вот ваш текст'. Пиши простой текст без маркдауна.",
  "temperature": 0.7,
  "max_tokens": 8000,
  "models": {
    "general": ["gemini"],
    "code": ["gemini"],
    "vision": ["gemini"],
    "audio": ["gemini"],
    "ocr": ["gemini"]
  },
  "chat_history_max_messages": 30,
  "chat_history_max_chars": 50000,
  "image_char_cost": 2000
}
```

### Формат конфигурации Tavily

Файл `tavily.conf` в формате JSON:

```json
{
  "api_keys": [
    "ваш_первый_tavily_api_ключ",
    "ваш_второй_tavily_api_ключ",
    "ваш_третий_tavily_api_ключ"
  ]
}
```

## Управление ключами

### Добавление ключей

```bash
# Добавить Pollinations API ключ (необязательно, так как Pollinations может работать без ключа)
plnllm -save-key ваш_pollinations_api_ключ

# Добавить Tavily API ключ (для инструмента поиска)
plnllm -add-tavily-key tvly-abcdefghijklmnopqrstuvwxyz1234567890
```

### Множественные ключи

Pollinations поддерживает использование нескольких ключей:
- Для Tavily API: случайное перемешивание ключей для равномерного распределения нагрузки

## Логирование

- **Вербозный режим**: Используйте флаг `-v` для подробного логирования в stderr
- **Файл логов ошибок**: `%APPDATA%\clipgen-m\pollinations_err.log`
- **Ротация логов**: Файл логов ротируется при достижении 10MB

## Система вызова инструментов

Pollinations использует встроенную систему вызова инструментов:

### Калькулятор (Lua)

- Выполняет математические вычисления с высокой точностью
- Поддерживает все функции Lua и стандартные библиотеки
- Может выполнять сложные алгоритмы и скрипты
- Безопасное выполнение в изолированной среде

### Поиск (Tavily и Pollinations Search)

- Выполняет веб-поиск с актуальной информацией
- Возвращает краткие выжимки и топ результатов
- Поддерживает несколько API-ключей с ротацией
- Ограничивает размер контента для предотвращения перегрузки контекста
- Использует двухэтапный поиск: сначала через модель gemini-search на Pollinations, затем резервный вариант через Tavily

## Совместимость

- **ОС**: Windows, Linux, macOS (требуется адаптация путей)
- **Требования**: Современная версия Go (для работы Lua-исполнителя)
- **Зависимости**: golang.org/x/text/encoding/charmap, другие стандартные библиотеки Go

## Устранение неполадок

1. **"Нет входных данных"**: Убедитесь, что вы передаете что-то в stdin или используете файлы
2. **"Нет API ключей"**: Добавьте хотя бы один ключ с помощью `plnllm -add-tavily-key ВАШ_КЛЮЧ` (Pollinations может работать без ключа)
3. **Ошибки с инструментами**: Проверьте, установлены ли соответствующие конфигурации
4. **Проблемы с Lua**: Убедитесь, что исполняемый файл `lua-executor` доступен
5. **Проблемы с Tavily**: Убедитесь, что файл `tavily.conf` правильно настроен

## Разработка

Проект написан на Go и может быть скомпилирован с помощью:

```bash
go build -o plnllm.exe main.go
```

### Архитектура

- **main.go**: Основная логика приложения
- **lua-executor**: Подсистема выполнения Lua-скриптов (внешняя зависимость)
- **Tavily интеграция**: Подсистема поиска через Tavily

## Лицензия

Этот проект распространяется по лицензии MIT.

## Авторы

ClipGen-m проект